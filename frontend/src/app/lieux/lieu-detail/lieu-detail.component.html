<div class="lieu-detail-page" *ngIf="lieu" [@fadeInUp]>
  <!-- Modern Header with Breadcrumb -->
  <div class="detail-header">
    <div class="container">
      <nav class="breadcrumb">
        <a routerLink="/" class="breadcrumb-link">Accueil</a>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9,18 15,12 9,6"/>
        </svg>
        <a routerLink="/search" class="breadcrumb-link">Recherche</a>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9,18 15,12 9,6"/>
        </svg>
        <span class="breadcrumb-current">{{ lieu.titre }}</span>
      </nav>
  
  <header class="detail-header">
    <div class="header-content">
      <h1>{{ lieu.titre }}</h1>
      <div class="header-actions">
        <button class="action-btn share-btn" (click)="sharePlace()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="18" cy="5" r="3"></circle>
            <circle cx="6" cy="12" r="3"></circle>
            <circle cx="18" cy="19" r="3"></circle>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
          </svg>
          <span>Partager</span>
        </button>
        <button class="action-btn save-btn" [class.saved]="isSaved" (click)="toggleSave()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
          </svg>
          <span>{{ isSaved ? 'Sauvegardé' : 'Sauvegarder' }}</span>
        </button>
      </div>
    </div>
    
    <div class="header-meta">
      <div class="rating-info">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="#F59E0B" stroke="#F59E0B" stroke-width="0.5">
          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
        </svg>
        <span class="rating">{{ averageRating | number:'1.1-1' }}</span>
        <span class="separator">·</span>
        <a href="#reviews" class="reviews-link">{{ lieu.reviews.length }} avis</a>
      </div>
      <div class="location-info">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <span>{{ lieu.ville }}, France</span>
      </div>
    </div>
  </header>

  <!-- Modern Photo Gallery -->
  <div class="photo-gallery">
    <div class="gallery-grid">
      <div class="main-image" (click)="openLightbox(0)">
        <img [src]="lieu.photos[0]" [alt]="'Image principale de ' + lieu.titre" loading="lazy">
        <div class="image-overlay">
          <div class="image-badge">Image principale</div>
        </div>
      </div>
      
      <div class="thumbnail-grid">
        <div *ngFor="let photo of lieu.photos.slice(1, 5); let i = index" 
             class="thumbnail" 
             (click)="openLightbox(i + 1)" 
             [class.active]="photo === selectedImage">
          <img [src]="photo" [alt]="'Image de ' + lieu.titre" loading="lazy">
          <div class="image-overlay"></div>
        </div>
      </div>
      
      <button class="view-all-photos" (click)="openLightbox(0)" *ngIf="lieu.photos.length > 5">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
        <span>Voir toutes les photos ({{ lieu.photos.length }})</span>
      </button>
    </div>
  </div>

  <!-- Modern Main Content & Booking Sidebar -->
  <div class="detail-content-grid">
    <main class="main-info">
      <!-- Host Info Section -->
      <section class="host-section">
        <div class="host-info">
          <div class="host-details">
            <h2>{{ lieu.type }} entièrement géré par {{ lieu.host.name }}</h2>
            <div class="host-stats">
              <span>{{ lieu.capacity }} voyageurs</span>
              <span class="separator">·</span>
              <span>{{ lieu.bedrooms }} chambres</span>
              <span class="separator">·</span>
              <span>{{ lieu.bathrooms }} salle(s) de bain</span>
            </div>
          </div>
          <div class="host-avatar-container">
            <img [src]="lieu.host.avatar" [alt]="'Avatar de ' + lieu.host.name" class="host-avatar">
            <div class="host-badge" *ngIf="lieu.host.isSuperHost">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              <span>SuperHost</span>
            </div>
          </div>
        </div>
        
        <div class="key-features">
          <div class="feature">
            <div class="feature-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
            <div class="feature-text">
              <h4>Hôte expérimenté</h4>
              <p>{{ lieu.host.name }} a accueilli {{ lieu.host.guestCount }}+ voyageurs</p>
            </div>
          </div>
          
          <div class="feature">
            <div class="feature-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
            </div>
            <div class="feature-text">
              <h4>Arrivée autonome</h4>
              <p>Accès facile avec code sécurisé</p>
            </div>
          </div>
          
          <div class="feature">
            <div class="feature-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
              </svg>
            </div>
            <div class="feature-text">
              <h4>Emplacement idéal</h4>
              <p>95% des voyageurs ont attribué 5 étoiles à l'emplacement</p>
            </div>
          </div>
        </div>
      </section>
      
      <div class="content-divider"></div>
      
      <!-- Description Section -->
      <section class="description-section">
        <h3>À propos de ce lieu</h3>
        <div class="description-content">
          <p>{{ lieu.description }}</p>
          <button class="btn-text" (click)="toggleFullDescription()" *ngIf="lieu.description.length > 300">
            {{ showFullDescription ? 'Afficher moins' : 'Afficher plus' }}
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline *ngIf="!showFullDescription" points="6 9 12 15 18 9"></polyline>
              <polyline *ngIf="showFullDescription" points="18 15 12 9 6 15"></polyline>
            </svg>
          </button>
        </div>
      </section>
      
      <div class="content-divider"></div>
      
      <!-- Amenities Section -->
      <section class="amenities-section">
        <div class="section-header">
          <h3>Ce que propose ce lieu</h3>
        </div>
        
        <div class="amenities-grid">
          <div class="amenity-item" *ngFor="let amenity of displayedAmenities">
            <div class="amenity-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path [attr.d]="getAmenityIcon(amenity)"></path>
              </svg>
            </div>
            <span>{{ amenity }}</span>
          </div>
        </div>
        
        <button class="btn-outline" (click)="showAllAmenities()" *ngIf="lieu.equipements.length > 8">
          <span>Afficher les {{ lieu.equipements.length }} équipements</span>
        </button>
      </section>
      
      <div class="content-divider"></div>
      
      <!-- Calendar Section -->
      <section class="calendar-section">
        <div class="section-header">
          <h3>Disponibilités</h3>
        </div>
        
        <div class="calendar-container">
          <!-- Calendar will be rendered here by flatpickr -->
          <div class="calendar-placeholder" #calendarContainer></div>
        </div>
        
        <div class="calendar-legend">
          <div class="legend-item">
            <span class="legend-color available"></span>
            <span>Disponible</span>
          </div>
          <div class="legend-item">
            <span class="legend-color booked"></span>
            <span>Réservé</span>
          </div>
        </div>
      </section>
      
      <div class="content-divider"></div>
      
      <!-- Location Section -->
      <section class="location-section">
        <div class="section-header">
          <h3>Emplacement</h3>
          <p>{{ lieu.ville }}, France</p>
        </div>
        
        <div class="map-container" #mapContainer></div>
        
        <div class="location-details">
          <h4>À propos du quartier</h4>
          <p>{{ lieu.locationDescription || 'Quartier calme et résidentiel, proche des transports en commun et des commerces. À 15 minutes à pied du centre-ville.' }}</p>
        </div>
      </section>
      
      <div class="content-divider"></div>
      
      <!-- Reviews Section -->
      <section id="reviews" class="reviews-section" *ngIf="lieu.reviews && lieu.reviews.length > 0">
        <div class="section-header">
          <div class="reviews-header">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#F59E0B" stroke="#F59E0B" stroke-width="0.5">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
            <h3>{{ averageRating | number:'1.1-1' }} · {{ lieu.reviews.length }} avis</h3>
          </div>
        </div>
        
        <div class="rating-categories" *ngIf="ratingCategories">
          <div class="rating-category" *ngFor="let category of ratingCategories">
            <span class="category-name">{{ category.name }}</span>
            <div class="rating-bar-container">
              <div class="rating-bar" [style.width.%]="category.score * 20"></div>
            </div>
            <span class="category-score">{{ category.score }}</span>
          </div>
        </div>
        
        <div class="reviews-grid">
          <div class="review-card" *ngFor="let review of displayedReviews">
            <div class="review-header">
              <img [src]="review.avatar" [alt]="'Avatar de ' + review.user" class="avatar">
              <div class="review-user-info">
                <h4>{{ review.user }}</h4>
                <p class="review-date">{{ review.date | date:'MMMM yyyy' }}</p>
              </div>
            </div>
            
            <div class="review-rating">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="#F59E0B" stroke="#F59E0B" stroke-width="0.5">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg>
              <span>{{ review.rating }}</span>
            </div>
            
            <p class="review-comment">{{ review.comment }}</p>
          </div>
        </div>
        
        <button class="btn-outline" (click)="showAllReviews()" *ngIf="lieu.reviews.length > 6 && !showAllReviewsFlag">
          <span>Afficher les {{ lieu.reviews.length }} avis</span>
        </button>
      </section>
      
      <div class="content-divider"></div>
      
      <!-- Host Section -->
      <section class="host-profile-section">
        <div class="section-header">
          <h3>À propos de votre hôte</h3>
        </div>
        
        <div class="host-profile">
          <div class="host-profile-header">
            <img [src]="lieu.host.avatar" [alt]="'Avatar de ' + lieu.host.name" class="host-avatar-large">
            <div class="host-profile-info">
              <h4>{{ lieu.host.name }}</h4>
              <p class="host-since">Membre depuis {{ lieu.host.memberSince || 'janvier 2020' }}</p>
              
              <div class="host-stats-badges">
                <div class="host-stat">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="#F59E0B" stroke="#F59E0B" stroke-width="0.5">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                  </svg>
                  <span>{{ lieu.host.rating || '4.9' }} ({{ lieu.host.reviewCount || '124' }} avis)</span>
                </div>
                
                <div class="host-stat" *ngIf="lieu.host.isIdentityVerified">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                  </svg>
                  <span>Identité vérifiée</span>
                </div>
                
                <div class="host-stat" *ngIf="lieu.host.isSuperHost">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l8.91-1.01L12 2z"/>
                  </svg>
                  <span>SuperHost</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="host-description">
            <p>{{ lieu.host.description || 'Passionné(e) par l\'accueil et le partage, je serai ravi(e) de vous faire découvrir mon espace et de vous aider à passer un séjour inoubliable.' }}</p>
          </div>
          
          <div class="host-contact">
            <button class="btn-outline" (click)="contactHost()">
              <span>Contacter l'hôte</span>
            </button>
          </div>
        </div>
      </section>
    </main>

    <!-- Modern Booking Sidebar -->
    <aside class="booking-sidebar">
      <div class="booking-card">
        <div class="booking-card-header">
          <div class="price-container">
            <span class="price-amount">{{ lieu.prix | currency:'EUR':'symbol':'1.0-0' }}</span>
            <span class="price-period">/ nuit</span>
          </div>
          
          <div class="booking-rating">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="#F59E0B" stroke="#F59E0B" stroke-width="0.5">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
            <span>{{ averageRating | number:'1.1-1' }}</span>
            <span class="separator">·</span>
            <a href="#reviews" class="reviews-count">{{ lieu.reviews.length }} avis</a>
          </div>
        </div>
        
        <div class="booking-form">
          <div class="date-range-picker">
            <div class="date-inputs">
              <div class="date-input check-in">
                <label for="check-in">Arrivée</label>
                <input type="text" id="check-in" placeholder="JJ/MM/AAAA" [value]="checkInFormatted" readonly (click)="openDatePicker()">
              </div>
              <div class="date-input check-out">
                <label for="check-out">Départ</label>
                <input type="text" id="check-out" placeholder="JJ/MM/AAAA" [value]="checkOutFormatted" readonly (click)="openDatePicker()">
              </div>
            </div>
            
            <div class="flatpickr-container" #datePickerContainer></div>
          </div>
          
          <div class="guests-selector" (click)="toggleGuestsDropdown()">
            <div class="guests-input">
              <label for="guests">Voyageurs</label>
              <div class="guests-display">
                <span>{{ totalGuests }} voyageur{{ totalGuests > 1 ? 's' : '' }}</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline [class.rotated]="isGuestsDropdownOpen" points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
            </div>
            
            <div class="guests-dropdown" *ngIf="isGuestsDropdownOpen">
              <div class="guest-type">
                <div class="guest-type-info">
                  <h4>Adultes</h4>
                  <p>13 ans et plus</p>
                </div>
                <div class="guest-counter">
                  <button [disabled]="adults === 1" (click)="updateGuests('adults', -1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </button>
                  <span>{{ adults }}</span>
                  <button [disabled]="adults + children >= (lieu.capacity || 10)" (click)="updateGuests('adults', 1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </button>
                </div>
              </div>
              
              <div class="guest-type">
                <div class="guest-type-info">
                  <h4>Enfants</h4>
                  <p>2 à 12 ans</p>
                </div>
                <div class="guest-counter">
                  <button [disabled]="children === 0" (click)="updateGuests('children', -1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </button>
                  <span>{{ children }}</span>
                  <button [disabled]="adults + children >= (lieu.capacity || 10)" (click)="updateGuests('children', 1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </button>
                </div>
              </div>
              
              <div class="guest-type">
                <div class="guest-type-info">
                  <h4>Bébés</h4>
                  <p>Moins de 2 ans</p>
                </div>
                <div class="guest-counter">
                  <button [disabled]="infants === 0" (click)="updateGuests('infants', -1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </button>
                  <span>{{ infants }}</span>
                  <button [disabled]="infants >= 5" (click)="updateGuests('infants', 1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </button>
                </div>
              </div>
              
              <div class="guests-dropdown-footer">
                <button class="btn-text" (click)="closeGuestsDropdown()">Fermer</button>
              </div>
            </div>
          </div>
        </div>
        
        <button class="btn-primary" [disabled]="!isValidBooking" (click)="goToReservation()">
          <span *ngIf="isValidBooking">Réserver</span>
          <span *ngIf="!isValidBooking">Sélectionnez des dates</span>
        </button>
        
        <div class="booking-note" *ngIf="!isValidBooking">
          <p>Vous ne serez pas débité pour le moment</p>
        </div>
        
        <div class="price-breakdown" *ngIf="totalNights > 0">
          <div class="price-item">
            <span>{{ lieu.prix | currency:'EUR' }} x {{ totalNights }} nuits</span>
            <span>{{ (lieu.prix * totalNights) | currency:'EUR' }}</span>
          </div>
          <div class="price-item">
            <span>Frais de service</span>
            <span>{{ (totalPrice * 0.1) | currency:'EUR' }}</span>
          </div>
          <div class="price-item">
            <span>Taxes</span>
            <span>{{ (totalPrice * 0.05) | currency:'EUR' }}</span>
          </div>
          <div class="price-total">
            <span>Total</span>
            <span>{{ (totalPrice * 1.15) | currency:'EUR' }}</span>
          </div>
        </div>
      </div>
      
      <div class="report-listing">
        <button class="btn-text" (click)="reportListing()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          <span>Signaler cette annonce</span>
        </button>
      </div>
    </aside>
  </div>

  <a routerLink="/reservation/{{lieu.id}}" class="floating-reservation-button">Réserver</a>
</div>

<!-- Lightbox -->
<app-lightbox *ngIf="isLightboxOpen && lieu"
              [images]="lieu.photos"
              [currentImageIndex]="selectedImageIndex"
              (close)="closeLightbox()">
</app-lightbox>

<ng-template #notFound>
  <div class="not-found">
    <h2>Lieu non trouvé</h2>
    <p>Désolé, nous n'avons pas pu trouver les détails pour ce lieu.</p>
    <a routerLink="/lieux">Retour à la liste</a>
  </div>
</ng-template>
