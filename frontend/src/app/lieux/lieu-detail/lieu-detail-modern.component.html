<div class="lieu-detail-page" *ngIf="lieu" [@fadeInUp]>
  <!-- Modern Header with Breadcrumb -->
  <div class="detail-header">
    <div class="container">
      <nav class="breadcrumb">
        <a routerLink="/" class="breadcrumb-link">Accueil</a>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9,18 15,12 9,6"/>
        </svg>
        <a routerLink="/search" class="breadcrumb-link">Recherche</a>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9,18 15,12 9,6"/>
        </svg>
        <span class="breadcrumb-current">{{ lieu.titre }}</span>
      </nav>

      <div class="header-content">
        <div class="title-section">
          <h1 class="place-title">{{ lieu.titre }}</h1>
          <div class="place-meta">
            <div class="rating-location">
              <div class="rating">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                <span class="rating-value">{{ averageRating | number:'1.1-1' }}</span>
                <span class="rating-count">({{ lieu.reviews?.length || 0 }} avis)</span>
              </div>
              <div class="location">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                  <circle cx="12" cy="10" r="3"/>
                </svg>
                <span>{{ lieu.ville }}, France</span>
              </div>
            </div>
          </div>
        </div>

        <div class="header-actions">
          <button class="action-btn" (click)="sharePlace()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="18" cy="5" r="3"/>
              <circle cx="6" cy="12" r="3"/>
              <circle cx="18" cy="19" r="3"/>
              <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
              <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
            </svg>
            Partager
          </button>
          <button class="action-btn" [class.active]="isSaved" (click)="toggleSave()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
            </svg>
            {{ isSaved ? 'Sauvegardé' : 'Sauvegarder' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="detail-content">
    <div class="container">
      <div class="content-layout">
        <!-- Main Content -->
        <main class="main-content">
          <!-- Modern Photo Gallery -->
          <section class="photo-gallery" id="photos">
            <div class="gallery-grid">
              <div class="main-photo" (click)="openLightbox(0)">
                <img [src]="lieu.photos[0]" [alt]="lieu.titre" class="main-image">
                <div class="photo-overlay">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21,15 16,10 5,21"/>
                  </svg>
                </div>
              </div>
              <div class="thumbnail-grid">
                <div 
                  *ngFor="let photo of lieu.photos.slice(1, 5); let i = index"
                  class="thumbnail"
                  (click)="openLightbox(i + 1)">
                  <img [src]="photo" [alt]="lieu.titre + ' - Photo ' + (i + 2)">
                  <div class="photo-overlay" *ngIf="i === 3 && lieu.photos.length > 5">
                    <span class="more-photos">+{{ lieu.photos.length - 5 }}</span>
                  </div>
                </div>
              </div>
            </div>
            <button class="view-all-photos" (click)="openLightbox(0)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21,15 16,10 5,21"/>
              </svg>
              Voir toutes les photos
            </button>
          </section>

          <!-- Place Info Section -->
          <section class="place-info" id="about">
            <div class="info-grid">
              <div class="main-info">
                <div class="host-section">
                  <div class="host-info">
                    <div class="host-avatar">
                      <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100&h=100&fit=crop&crop=face" alt="Hôte">
                    </div>
                    <div class="host-details">
                      <h3>{{ lieu.type }} hébergé par {{ lieu.proprietaire || 'Ahmed' }}</h3>
                      <p>{{ lieu.capacite }} voyageurs • {{ lieu.chambres || 2 }} chambres • {{ lieu.lits || 3 }} lits • {{ lieu.sallesDeBain || 1 }} salle de bain</p>
                    </div>
                  </div>
                  <app-modern-button variant="ghost" size="sm" (click)="contactHost()">
                    Contacter l'hôte
                  </app-modern-button>
                </div>

                <div class="features-highlights">
                  <div class="feature-item">
                    <div class="feature-icon">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12l2 2 4-4"/>
                        <circle cx="12" cy="12" r="10"/>
                      </svg>
                    </div>
                    <div class="feature-content">
                      <h4>Arrivée autonome</h4>
                      <p>Vous pouvez faire l'arrivée avec le digicode.</p>
                    </div>
                  </div>
                  <div class="feature-item">
                    <div class="feature-icon">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                      </svg>
                    </div>
                    <div class="feature-content">
                      <h4>Expérience 5 étoiles</h4>
                      <p>Les voyageurs donnent une note de 5 étoiles à cet hébergement.</p>
                    </div>
                  </div>
                  <div class="feature-item">
                    <div class="feature-icon">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                      </svg>
                    </div>
                    <div class="feature-content">
                      <h4>Emplacement idéal</h4>
                      <p>100% des voyageurs récents ont attribué 5 étoiles à l'emplacement.</p>
                    </div>
                  </div>
                </div>

                <div class="description-section">
                  <h3>À propos de ce logement</h3>
                  <div class="description-content" [class.expanded]="showFullDescription">
                    <p>{{ lieu.description }}</p>
                  </div>
                  <button 
                    *ngIf="lieu.description && lieu.description.length > 200"
                    class="show-more-btn" 
                    (click)="toggleFullDescription()">
                    {{ showFullDescription ? 'Afficher moins' : 'Afficher plus' }}
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline [attr.points]="showFullDescription ? '18,15 12,9 6,15' : '6,9 12,15 18,9'"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </section>

          <!-- Amenities Section -->
          <section class="amenities-section" id="amenities">
            <h3>Ce que propose ce logement</h3>
            <div class="amenities-grid">
              <div 
                *ngFor="let amenity of displayedAmenities" 
                class="amenity-item">
                <div class="amenity-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path [attr.d]="getAmenityIcon(amenity)"/>
                  </svg>
                </div>
                <span class="amenity-label">{{ amenity }}</span>
              </div>
            </div>
            <app-modern-button 
              *ngIf="lieu.equipements && lieu.equipements.length > displayedAmenities.length"
              variant="ghost" 
              (click)="showAllAmenities()">
              Afficher les {{ lieu.equipements.length }} équipements
            </app-modern-button>
          </section>

          <!-- Calendar Section -->
          <section class="calendar-section" id="calendar">
            <h3>Sélectionnez vos dates</h3>
            <p class="calendar-subtitle">Ajoutez vos dates de voyage pour connaître les tarifs exacts</p>
            <div class="calendar-container">
              <div #calendarContainer class="inline-calendar"></div>
            </div>
          </section>
        </main>

        <!-- Sticky Booking Sidebar -->
        <aside class="booking-sidebar" #bookingSidebar [class.sticky]="isSidebarSticky">
          <app-glass-card [customStyles]="{'position': 'sticky', 'top': '2rem'}">
            <div class="booking-card">
              <div class="booking-header">
                <div class="price-section">
                  <span class="price">{{ lieu.prix }}€</span>
                  <span class="price-unit">par nuit</span>
                </div>
                <div class="rating-section">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                  <span class="rating-value">{{ averageRating | number:'1.1-1' }}</span>
                  <span class="rating-count">({{ lieu.reviews?.length || 0 }})</span>
                </div>
              </div>

              <div class="booking-form">
                <!-- Date Selection -->
                <div class="date-inputs">
                  <div class="date-input-group">
                    <label>ARRIVÉE</label>
                    <input 
                      type="text" 
                      [value]="checkInFormatted" 
                      placeholder="Ajouter une date"
                      readonly
                      (click)="openDatePicker()">
                  </div>
                  <div class="date-input-group">
                    <label>DÉPART</label>
                    <input 
                      type="text" 
                      [value]="checkOutFormatted" 
                      placeholder="Ajouter une date"
                      readonly
                      (click)="openDatePicker()">
                  </div>
                </div>

                <!-- Guests Selection -->
                <div class="guests-input" (click)="toggleGuestsDropdown()">
                  <label>VOYAGEURS</label>
                  <div class="guests-display">
                    <span>{{ totalGuests }} voyageur{{ totalGuests > 1 ? 's' : '' }}</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="6,9 12,15 18,9"/>
                    </svg>
                  </div>
                  
                  <!-- Guests Dropdown -->
                  <div class="guests-dropdown" *ngIf="isGuestsDropdownOpen" (click)="$event.stopPropagation()">
                    <div class="guest-type">
                      <div class="guest-info">
                        <span class="guest-label">Adultes</span>
                        <span class="guest-description">13 ans et plus</span>
                      </div>
                      <div class="guest-controls">
                        <button 
                          class="guest-btn" 
                          [disabled]="adults <= 1"
                          (click)="updateGuests('adults', -1)">-</button>
                        <span class="guest-count">{{ adults }}</span>
                        <button 
                          class="guest-btn"
                          (click)="updateGuests('adults', 1)">+</button>
                      </div>
                    </div>
                    <div class="guest-type">
                      <div class="guest-info">
                        <span class="guest-label">Enfants</span>
                        <span class="guest-description">De 2 à 12 ans</span>
                      </div>
                      <div class="guest-controls">
                        <button 
                          class="guest-btn" 
                          [disabled]="children <= 0"
                          (click)="updateGuests('children', -1)">-</button>
                        <span class="guest-count">{{ children }}</span>
                        <button 
                          class="guest-btn"
                          (click)="updateGuests('children', 1)">+</button>
                      </div>
                    </div>
                    <div class="guest-type">
                      <div class="guest-info">
                        <span class="guest-label">Bébés</span>
                        <span class="guest-description">Moins de 2 ans</span>
                      </div>
                      <div class="guest-controls">
                        <button 
                          class="guest-btn" 
                          [disabled]="infants <= 0"
                          (click)="updateGuests('infants', -1)">-</button>
                        <span class="guest-count">{{ infants }}</span>
                        <button 
                          class="guest-btn"
                          (click)="updateGuests('infants', 1)">+</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Hidden Date Picker -->
                <div #datePickerContainer class="hidden-datepicker"></div>

                <!-- Reserve Button -->
                <app-modern-button 
                  variant="primary" 
                  size="lg" 
                  [disabled]="!isValidBooking"
                  (click)="goToReservation()"
                  class="reserve-btn">
                  {{ isValidBooking ? 'Réserver maintenant' : 'Vérifier la disponibilité' }}
                </app-modern-button>

                <p class="no-charge-text">Aucun montant ne vous sera débité pour le moment</p>

                <!-- Price Breakdown -->
                <div class="price-breakdown" *ngIf="totalNights > 0">
                  <div class="price-line">
                    <span>{{ lieu.prix }}€ x {{ totalNights }} nuit{{ totalNights > 1 ? 's' : '' }}</span>
                    <span>{{ totalPrice }}€</span>
                  </div>
                  <div class="price-line">
                    <span>Frais de service LocaSpace</span>
                    <span>{{ (totalPrice * 0.1) | number:'1.0-0' }}€</span>
                  </div>
                  <div class="price-line total">
                    <span>Total</span>
                    <span>{{ totalPrice + (totalPrice * 0.1) | number:'1.0-0' }}€</span>
                  </div>
                </div>
              </div>
            </div>
          </app-glass-card>
        </aside>
      </div>
    </div>
  </div>

  <!-- Reviews Section -->
  <section class="reviews-section" id="reviews">
    <div class="container">
      <div class="reviews-header">
        <h3>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          {{ averageRating | number:'1.1-1' }} • {{ lieu.reviews?.length || 0 }} avis
        </h3>
      </div>

      <!-- Rating Categories -->
      <div class="rating-categories" *ngIf="ratingCategories.length > 0">
        <div class="categories-grid">
          <div *ngFor="let category of ratingCategories" class="category-item">
            <div class="category-info">
              <span class="category-name">{{ category.name }}</span>
              <span class="category-score">{{ category.score }}</span>
            </div>
            <div class="category-bar">
              <div class="category-fill" [style.width.%]="(category.score / 5) * 100"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Reviews Grid -->
      <div class="reviews-grid" *ngIf="displayedReviews.length > 0">
        <div *ngFor="let review of displayedReviews" class="review-card">
          <div class="review-header">
            <div class="reviewer-info">
              <img [src]="review.avatar" [alt]="review.user" class="reviewer-avatar">
              <div class="reviewer-details">
                <h4 class="reviewer-name">{{ review.user }}</h4>
                <p class="review-date">{{ review.date | date:'MMMM yyyy' }}</p>
              </div>
            </div>
            <div class="review-rating">
              <svg *ngFor="let star of getStarArray(review.rating)" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
            </div>
          </div>
          <p class="review-comment">{{ review.comment }}</p>
        </div>
      </div>

      <app-modern-button 
        *ngIf="lieu.reviews && lieu.reviews.length > displayedReviews.length"
        variant="ghost" 
        (click)="showAllReviews()">
        Afficher les {{ lieu.reviews.length }} avis
      </app-modern-button>
    </div>
  </section>

  <!-- Location Section -->
  <section class="location-section" id="location">
    <div class="container">
      <h3>Où vous dormirez</h3>
      <div class="location-content">
        <div class="map-container" #mapContainer></div>
        <div class="location-info">
          <h4>{{ lieu.ville }}, France</h4>
          <p>{{ lieu.description }}</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Navigation Dots (for smooth scrolling) -->
  <div class="navigation-dots">
    <button class="nav-dot" (click)="scrollToSection('photos')" title="Photos"></button>
    <button class="nav-dot" (click)="scrollToSection('about')" title="À propos"></button>
    <button class="nav-dot" (click)="scrollToSection('amenities')" title="Équipements"></button>
    <button class="nav-dot" (click)="scrollToSection('reviews')" title="Avis"></button>
    <button class="nav-dot" (click)="scrollToSection('location')" title="Emplacement"></button>
  </div>

  <!-- Lightbox -->
  <app-lightbox 
    *ngIf="isLightboxOpen"
    [images]="lieu.photos"
    [currentIndex]="selectedImageIndex"
    (close)="closeLightbox()">
  </app-lightbox>
</div>