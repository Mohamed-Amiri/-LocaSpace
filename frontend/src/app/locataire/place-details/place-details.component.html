<div class="place-details-container" *ngIf="!loading && place">
  <!-- Header with Back Button -->
  <div class="header-section">
    <button class="back-btn" (click)="goBack()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      {{getBackButtonText()}}
    </button>
  </div>

  <!-- Hero Section with Images -->
  <div class="hero-section">
    <div class="image-gallery">
      <div class="main-image">
        <img [src]="place.images[selectedImageIndex]" [alt]="place.title" class="hero-image">
        <div class="image-overlay">
          <button class="favorite-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.5783 8.50903 2.9987 7.05 2.9987C5.59096 2.9987 4.19169 3.5783 3.16 4.61C2.1283 5.6417 1.5487 7.04097 1.5487 8.5C1.5487 9.95903 2.1283 11.3583 3.16 12.39L12 21.23L20.84 12.39C21.351 11.8792 21.7563 11.2728 22.0329 10.6053C22.3095 9.93789 22.4518 9.22248 22.4518 8.5C22.4518 7.77752 22.3095 7.06211 22.0329 6.39467C21.7563 5.72723 21.351 5.1208 20.84 4.61V4.61Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button class="share-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="18" cy="5" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="6" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="18" cy="19" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>
      
      <div class="thumbnail-gallery">
        @for (image of place.images; track $index) {
        <button 
          class="thumbnail-btn"
          [class.active]="selectedImageIndex === $index"
          (click)="selectImage($index)">
          <img [src]="image" [alt]="'Image ' + ($index + 1)" class="thumbnail-image">
        </button>
        }
      </div>
    </div>
  </div>

  <!-- Content Section -->
  <div class="content-section">
    <div class="main-content">
      <!-- Place Info -->
      <div class="place-info">
        <div class="place-header">
          <h1 class="place-title">{{place.title}}</h1>
          <div class="place-meta">
            <div class="location">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 10C21 17 12 23 12 23S3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.3639 3.63604C20.0518 5.32387 21 7.61305 21 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              {{place.location}}
            </div>
            <div class="rating">
              <div class="stars">
                @for (filled of getStarArray(place.rating); track $index) {
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" [class.filled]="filled">
                  <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" [attr.fill]="filled ? 'currentColor' : 'none'"/>
                </svg>
                }
              </div>
              <span class="rating-text">{{place.rating}} ({{place.reviews.length}} avis)</span>
            </div>
          </div>
        </div>

        <div class="description">
          <h3>À propos de ce logement</h3>
          <p>{{place.description}}</p>
        </div>

        <!-- Amenities -->
        <div class="amenities-section">
          <h3>Équipements</h3>
          <div class="amenities-grid">
            @for (amenity of (showAllAmenities ? place.amenities : place.amenities.slice(0, 6)); track amenity) {
            <div class="amenity-item">
              <span class="amenity-icon">{{getAmenityIcon(amenity)}}</span>
              <span class="amenity-name">{{amenity}}</span>
            </div>
            }
          </div>
          @if (place.amenities.length > 6) {
          <button class="show-more-btn" (click)="toggleAmenities()">
            {{showAllAmenities ? 'Voir moins' : 'Voir tous les équipements (' + place.amenities.length + ')'}}
          </button>
          }
        </div>

        <!-- Reviews -->
        <div class="reviews-section">
          <div class="reviews-header">
            <div class="reviews-title-section">
              <h3>Avis des voyageurs</h3>
              @if (canAddReview()) {
              <button class="add-review-btn" (click)="addReview()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                {{getAddReviewButtonText()}}
              </button>
              } @else if (hasUserReviewed) {
              <div class="review-status">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.7088 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4905 2.02168 11.3363C2.16356 9.18203 2.99721 7.13214 4.39828 5.49883C5.79935 3.86553 7.69279 2.72636 9.79619 2.24223C11.8996 1.75809 14.1003 1.95185 16.07 2.79999" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <polyline points="22,4 12,14.01 9,11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                {{getReviewStatusText()}}
              </div>
              }
            </div>
            <div class="reviews-summary">
              <div class="average-rating">
                <span class="rating-number">{{place.rating}}</span>
                <div class="stars">
                  @for (filled of getStarArray(place.rating); track $index) {
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" [class.filled]="filled">
                    <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" [attr.fill]="filled ? 'currentColor' : 'none'"/>
                  </svg>
                  }
                </div>
                <span class="reviews-count">{{place.reviews.length}} avis</span>
              </div>
            </div>
          </div>

          <div class="reviews-list">
            @for (review of (showAllReviews ? place.reviews : place.reviews.slice(0, 3)); track review.id) {
            <div class="review-item">
              <div class="review-header">
                <div class="reviewer-info">
                  <div class="reviewer-avatar">
                    {{review.userName.charAt(0).toUpperCase()}}
                  </div>
                  <div class="reviewer-details">
                    <h4 class="reviewer-name">{{review.userName}}</h4>
                    <span class="review-date">{{review.date | date:'MMMM yyyy'}}</span>
                  </div>
                </div>
                <div class="review-rating">
                  @for (filled of getStarArray(review.rating); track $index) {
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" [class.filled]="filled">
                    <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" [attr.fill]="filled ? 'currentColor' : 'none'"/>
                  </svg>
                  }
                </div>
              </div>
              <p class="review-comment">{{review.comment}}</p>
            </div>
            }
          </div>

          @if (place.reviews.length > 3) {
          <button class="show-more-btn" (click)="toggleReviews()">
            {{showAllReviews ? 'Voir moins d\'avis' : 'Voir tous les avis (' + place.reviews.length + ')'}}
          </button>
          }
        </div>
      </div>
    </div>

    <!-- Booking Sidebar -->
    <div class="booking-sidebar">
      @if (hasActiveBooking && activeBooking) {
      <!-- Already Booked State -->
      <div class="booking-card already-booked">
        <div class="booked-header">
          <div class="booked-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.7088 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4905 2.02168 11.3363C2.16356 9.18203 2.99721 7.13214 4.39828 5.49883C5.79935 3.86553 7.69279 2.72636 9.79619 2.24223C11.8996 1.75809 14.1003 1.95185 16.07 2.79999" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <polyline points="22,4 12,14.01 9,11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h3>Vous avez déjà réservé ce logement</h3>
        </div>

        <div class="booking-details">
          <div class="detail-item">
            <span class="label">Statut</span>
            <span class="value status-{{activeBooking.status}}">
              @if (activeBooking.status === 'pending') {
                En attente de confirmation
              } @else if (activeBooking.status === 'confirmed') {
                Confirmée
              }
            </span>
          </div>
          <div class="detail-item">
            <span class="label">Dates</span>
            <span class="value">{{formatBookingDate(activeBooking.startDate)}} - {{formatBookingDate(activeBooking.endDate)}}</span>
          </div>
          <div class="detail-item">
            <span class="label">Voyageurs</span>
            <span class="value">{{activeBooking.guests || 1}} personne{{(activeBooking.guests || 1) > 1 ? 's' : ''}}</span>
          </div>
          <div class="detail-item">
            <span class="label">Prix total</span>
            <span class="value price">{{activeBooking.totalPrice}}€</span>
          </div>
          <div class="detail-item">
            <span class="label">Numéro de réservation</span>
            <span class="value">#{{activeBooking.id}}</span>
          </div>
        </div>

        <div class="booked-actions">
          <button class="manage-booking-btn" (click)="navigateToReservations()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M9 11H15M9 15H15M17 21H7C5.89543 21 5 20.1046 5 19V5C5 3.89543 5.89543 3 7 3H12.5858C12.851 3 13.1054 3.10536 13.2929 3.29289L19.7071 9.70711C19.8946 9.89464 20 10.149 20 10.4142V19C20 20.1046 19.1046 21 18 21H17Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Gérer ma réservation
          </button>
        </div>

        <div class="booking-note">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 16V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Vous pouvez gérer cette réservation depuis votre page "Mes réservations"</span>
        </div>
      </div>
      } @else {
      <!-- Normal Booking Form -->
      <div class="booking-card">
        <div class="price-section">
          <div class="price">
            <span class="amount">{{place.price}}€</span>
            <span class="period">par nuit</span>
          </div>
          <div class="rating-badge">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="currentColor"/>
            </svg>
            <span>{{place.rating}}</span>
            <span class="reviews-count">({{place.reviews.length}})</span>
          </div>
        </div>

        <div class="booking-form">
          <div class="date-inputs">
            <div class="date-input">
              <label>Arrivée</label>
              <input type="date" class="date-field" [(ngModel)]="checkInDate" [min]="getTomorrowDate()">
            </div>
            <div class="date-input">
              <label>Départ</label>
              <input type="date" class="date-field" [(ngModel)]="checkOutDate" [min]="getMinCheckOutDate()">
            </div>
          </div>

          <div class="guests-input">
            <label>Voyageurs</label>
            <select class="guests-field" [(ngModel)]="guests">
              <option value="1">1 voyageur</option>
              <option value="2">2 voyageurs</option>
              <option value="3">3 voyageurs</option>
              <option value="4">4 voyageurs</option>
              <option value="5">5+ voyageurs</option>
            </select>
          </div>

          <button class="book-btn" (click)="bookPlace()" [disabled]="isBooking">
            @if (isBooking) {
            <span>Réservation en cours...</span>
            <div class="booking-spinner"></div>
            } @else {
            <span>Réserver maintenant</span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <line x1="7" y1="17" x2="17" y2="7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <polyline points="7,7 17,7 17,17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            }
          </button>

          <p class="booking-note">Vous ne serez pas débité pour le moment</p>
        </div>

        <div class="price-breakdown">
          <div class="breakdown-item">
            <span>{{place.price}}€ × {{calculateNights()}} nuit{{calculateNights() > 1 ? 's' : ''}}</span>
            <span>{{subtotal}}€</span>
          </div>
          <div class="breakdown-item">
            <span>Frais de service</span>
            <span>{{serviceFee}}€</span>
          </div>
          <div class="breakdown-total">
            <span>Total</span>
            <span>{{calculateTotalPrice()}}€</span>
          </div>
        </div>
      </div>
      }
    </div>
  </div>
</div>

<!-- Loading State -->
@if (loading) {
<div class="loading-container">
  <div class="loading-spinner">
    <div class="spinner"></div>
  </div>
  <p>Chargement des détails...</p>
</div>
}